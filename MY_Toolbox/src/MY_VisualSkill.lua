--------------------------------------------
-- @Desc  : ¼¼ÄÜÏÔÊ¾ - Õ½¶·¿ÉÊÓ»¯
-- @Author: µÔÒ»Ãù @tinymins
-- @Date  : 2015-03-02 10:08:45
-- @Email : admin@derzh.com
-- @Last modified by:   Zhai Yiming
-- @Last modified time: 2017-05-05 18:15:10
--------------------------------------------
local _L = MY.LoadLangPack(MY.GetAddonInfo().szRoot.."MY_Toolbox/lang/")
local _C = {}
local INI_PATH = MY.GetAddonInfo().szRoot .. "MY_ToolBox/ui/MY_VisualSkill.ini"
local BOX_W = 55
local ANI_TIME = 450
local OUT_DISTANCE = 200
local defaultAnchor = {x = 0, y = -220, s = "BOTTOMCENTER", r = "BOTTOMCENTER"}
MY_VisualSkill = {}
MY_VisualSkill.bEnable = false
MY_VisualSkill.bPenetrable = true
MY_VisualSkill.anchorVisualSkill = defaultAnchor
MY_VisualSkill.nVisualSkillBoxCount = 5
RegisterCustomData("MY_VisualSkill.bEnable")
RegisterCustomData("MY_VisualSkill.bPenetrable")
RegisterCustomData("MY_VisualSkill.anchorVisualSkill")
RegisterCustomData("MY_VisualSkill.nVisualSkillBoxCount")

local function ApplyAnchor(frame)
	frame:SetPoint(defaultAnchor.s, 0, 0, defaultAnchor.r, defaultAnchor.x, defaultAnchor.y)
	frame:CorrectPos()
end

local function GetRealIndex(nIndex, nIndexBase, nCount)
	return (nIndex + nIndexBase) % nCount
end

local function UpdateUI(frame, during)
	local percentage = math.min(math.max(during / ANI_TIME, 0), 1)
	local hList = frame:Lookup("", "Handle_Boxes")
	local nCount = hList:GetItemCount()
	
	local nFirstIndex = GetRealIndex(0, frame.nIndexBase, nCount)
	hList:Lookup(nFirstIndex):SetAlpha((1 - percentage) * 255)
	hList:Lookup(nFirstIndex):SetRelX(-OUT_DISTANCE * percentage)
	
	local nLeftW = 0
	for i = 1, nCount - 2 do
		local hItem = hList:Lookup(GetRealIndex(i, frame.nIndexBase, nCount))
		hItem:SetAlpha(255)
		hItem:SetRelX(nLeftW + BOX_W * (1 - percentage))
		nLeftW = nLeftW + hItem:GetW()
	end
	
	local nLastIndex = GetRealIndex(nCount - 1, frame.nIndexBase, nCount)
	hList:Lookup(nLastIndex):SetAlpha(percentage * 255)
	hList:Lookup(nLastIndex):SetRelX(nLeftW + OUT_DISTANCE * (1 - percentage))
	
	hList:FormatAllItemPos()
end

local function DrawUI(frame)
	local hList = frame:Lookup("", "Handle_Boxes")
	local nOffset = MY_VisualSkill.nVisualSkillBoxCount - hList:GetItemCount() + 1
	if nOffset == 0 then
		return
	elseif nOffset > 0 then
		for i = 1, nOffset do
			hList:AppendItemFromIni(INI_PATH, "Handle_Box"):Lookup("Box_Skill"):Hide()
		end
	elseif nOffset < 0 then
		for i = nOffset, -1 do
			hList:RemoveItem(frame.nIndexBase)
			frame.nIndexBase = (frame.nIndexBase + 1) % hList:GetItemCount()
		end
	end
	local nBoxesW = BOX_W * MY_VisualSkill.nVisualSkillBoxCount
	frame:Lookup("", "Handle_Bg/Image_Bg_11"):SetW(nBoxesW - 34)
	frame:Lookup("", "Handle_Bg"):FormatAllItemPos()
	frame:Lookup("", ""):FormatAllItemPos()
	frame:SetW(nBoxesW + 176)
	hList:SetW(nBoxesW)
	UpdateUI(frame, ANI_TIME)
end

local function OnSkillCast(frame, dwSkillID, dwSkillLevel)
	-- get name
	local szSkillName, dwIconID = MY.Player.GetSkillName(dwSkillID, dwSkillLevel)
	if dwSkillID == 4097 then -- Æï³Ë
		dwIconID = 1899
	elseif Table_IsSkillFormation(dwSkillID, dwSkillLevel)        -- Õó·¨¼¼ÄÜ
		or Table_IsSkillFormationCaster(dwSkillID, dwSkillLevel)  -- Õó·¨ÊÍ·Å¼¼ÄÜ
		-- or dwSkillID == 230     -- (230)  Íò»¨ÉËº¦Õó·¨Ê©·Å  Æß¾øåÐÒ£Õó
		-- or dwSkillID == 347     -- (347)  ´¿ÑôÆø×ÚÕó·¨Ê©·Å  ¾Å¹¬°ËØÔÕó
		-- or dwSkillID == 526     -- (526)  ÆßÐãÖÎÁÆÕó·¨Ê©·Å  »¨ÔÂÁè·çÕó
		-- or dwSkillID == 662     -- (662)  Ìì²ß·ÀÓùÕó·¨ÊÍ·Å  ¾ÅÏåµØÐþÕó
		-- or dwSkillID == 740     -- (740)  ÉÙÁÖ·ÀÓùÕó·¨Ê©·Å  ½ð¸Õ·üÄ§Õó
		-- or dwSkillID == 745     -- (745)  ÉÙÁÖ¹¥»÷Õó·¨Ê©·Å  Ìì¹ÄÀ×ÒôÕó
		-- or dwSkillID == 754     -- (754)  Ìì²ß¹¥»÷Õó·¨ÊÍ·Å  ÎÀ¹«ÕÛ³åÕó
		-- or dwSkillID == 778     -- (778)  ´¿Ñô½£×ÚÕó·¨Ê©·Å  ±±¶·ÆßÐÇÕó
		-- or dwSkillID == 781     -- (781)  ÆßÐãÉËº¦Õó·¨Ê©·Å  ¾ÅÒô¾ªÏÒÕó
		-- or dwSkillID == 1020    -- (1020) Íò»¨ÖÎÁÆÕó·¨Ê©·Å  ÂäÐÇ¾ªºèÕó
		-- or dwSkillID == 1866    -- (1866) ²Ø½£Õó·¨ÊÍ·Å      ÒÀÉ½¹ÛÀ½Õó
		-- or dwSkillID == 2481    -- (2481) Îå¶¾ÖÎÁÆÕó·¨Ê©·Å  ÃîÊÖÖ¯ÌìÕó
		-- or dwSkillID == 2487    -- (2487) Îå¶¾¹¥»÷Õó·¨Ê©·Å  Íò¹ÆÊÉÐÄÕó
		-- or dwSkillID == 3216    -- (3216) ÌÆÃÅÍâ¹¦Õó·¨Ê©·Å  Á÷ÐÇ¸ÏÔÂÕó
		-- or dwSkillID == 3217    -- (3217) ÌÆÃÅÄÚ¹¦Õó·¨Ê©·Å  Ç§»ú°Ù±äÕó
		-- or dwSkillID == 4674    -- (4674) Ã÷½Ì¹¥»÷Õó·¨Ê©·Å  Ñ×ÍþÆÆÄ§Õó
		-- or dwSkillID == 4687    -- (4687) Ã÷½Ì·ÀÓùÕó·¨Ê©·Å  ÎÞÁ¿¹âÃ÷Õó
		-- or dwSkillID == 5311    -- (5311) Ø¤°ï¹¥»÷Õó·¨ÊÍ·Å  ½µÁú·ü»¢Õó
		-- or dwSkillID == 13228   -- (13228)  ÁÙ´¨ÁÐÉ½ÕóÊÍ·Å  ÁÙ´¨ÁÐÉ½Õó
		-- or dwSkillID == 13275   -- (13275)  ·æÁèºá¾øÕóÊ©·Å  ·æÁèºá¾øÕó
		or dwSkillID == 10         -- (10)    ºáÉ¨Ç§¾ü           ºáÉ¨Ç§¾ü
		or dwSkillID == 11         -- (11)    ÆÕÍ¨¹¥»÷-¹÷¹¥»÷    ÁùºÏ¹÷
		or dwSkillID == 12         -- (12)    ÆÕÍ¨¹¥»÷-Ç¹¹¥»÷    Ã·»¨Ç¹·¨
		or dwSkillID == 13         -- (13)    ÆÕÍ¨¹¥»÷-½£¹¥»÷    Èý²ñ½£·¨
		or dwSkillID == 14         -- (14)    ÆÕÍ¨¹¥»÷-È­Ì×¹¥»÷  ³¤È­
		or dwSkillID == 15         -- (15)    ÆÕÍ¨¹¥»÷-Ë«±ø¹¥»÷  Á¬»·Ë«µ¶
		or dwSkillID == 16         -- (16)    ÆÕÍ¨¹¥»÷-±Ê¹¥»÷    ÅÐ¹Ù±Ê·¨
		or dwSkillID == 1795       -- (1795)  ÆÕÍ¨¹¥»÷-ÖØ½£¹¥»÷  ËÄ¼¾½£·¨
		or dwSkillID == 2183       -- (2183)  ÆÕÍ¨¹¥»÷-³æµÑ¹¥»÷  ´ó»ÄµÑ·¨
		or dwSkillID == 3121       -- (3121)  ÆÕÍ¨¹¥»÷-¹­¹¥»÷    î¸·çïÚ·¨
		or dwSkillID == 4326       -- (4326)  ÆÕÍ¨¹¥»÷-Ë«µ¶¹¥»÷  ´óÄ®µ¶·¨
		or dwSkillID == 13039      -- (13039) ÆÕÍ¨¹¥»÷_¶Üµ¶¹¥»÷  ¾íÑ©µ¶
		or dwSkillID == 16010      -- (16010) ÆÕÍ¨¹¥»÷_°ÁËªµ¶¹¥»÷  Ëª·çµ¶·¨
		or dwSkillID == 17         -- (17)    ½­ºþ-·ÀÉíÎäÒÕ-´ò×ø ´ò×ø
		or dwSkillID == 18         -- (18)    Ì¤ÔÆ Ì¤ÔÆ
		or dwIconID  == 1817       -- ±ÕÕó
		or dwIconID  == 533        -- ´ò×ø
		or dwIconID  == 13         -- ×Ó¼¼ÄÜ
		or not szSkillName
		or szSkillName == ""
	then
		return
	end
	
	local hList = frame:Lookup("", "Handle_Boxes")
	local hItem = hList:Lookup(frame.nIndexBase)
	frame.nIndexBase = (frame.nIndexBase + 1) % hList:GetItemCount()
	
	local box = hItem:Lookup("Box_Skill")
	box:SetObject(UI_OBJECT_SKILL, dwSkillID, dwSkillLevel)
	box:SetObjectIcon(dwIconID)
	box:Show()
	
	frame.nTickStart = GetTickCount()
end

function MY_VisualSkill.OnFrameCreate()
	this.nIndexBase = 0
	DrawUI(this)
	this:RegisterEvent("RENDER_FRAME_UPDATE")
	this:RegisterEvent("UI_SCALED")
	this:RegisterEvent("DO_SKILL_CAST")
	this:RegisterEvent("ON_ENTER_CUSTOM_UI_MODE")
	this:RegisterEvent("ON_LEAVE_CUSTOM_UI_MODE")
	this:RegisterEvent("CUSTOM_UI_MODE_SET_DEFAULT")
	MY_VisualSkill.OnEvent("UI_SCALED")
end

function MY_VisualSkill.OnEvent(event)
	if event == "RENDER_FRAME_UPDATE" then
		if not this.nTickStart then
			return
		end
		local nTickDuring = GetTickCount() - this.nTickStart
		if nTickDuring > 600 then
			this.nTickStart = nil
		end
		UpdateUI(this, nTickDuring)
	elseif event == "UI_SCALED" then
		ApplyAnchor(this)
	elseif event == "DO_SKILL_CAST" then
		local dwID, dwSkillID, dwSkillLevel = arg0, arg1, arg2
		if dwID == GetControlPlayer().dwID then
			OnSkillCast(this, dwSkillID, dwSkillLevel)
		end
	elseif event == "ON_ENTER_CUSTOM_UI_MODE" then
		UpdateCustomModeWindow(this, szTip, MY_VisualSkill.bPenetrable)
	elseif event == "ON_LEAVE_CUSTOM_UI_MODE" then
		UpdateCustomModeWindow(this, szTip, MY_VisualSkill.bPenetrable)
	elseif event == "CUSTOM_UI_MODE_SET_DEFAULT" then
		MY_VisualSkill.anchorVisualSkill = defaultAnchor
		ApplyAnchor(this)
	end
end

function MY_VisualSkill.Open()
	Wnd.OpenWindow(INI_PATH, "MY_VisualSkill")
end

function MY_VisualSkill.GetFrame()
	return Station.Lookup("Normal/MY_VisualSkill")
end

function MY_VisualSkill.Close()
	Wnd.CloseWindow("MY_VisualSkill")
end

function MY_VisualSkill.Reload()
	if MY_VisualSkill.bEnable then
		local frame = MY_VisualSkill.GetFrame()
		if frame then
			DrawUI(frame)
		else
			MY_VisualSkill.Open()
		end
	else
		MY_VisualSkill.Close()
	end
end
MY.RegisterInit('MY_VISUALSKILL', MY_VisualSkill.Reload)
